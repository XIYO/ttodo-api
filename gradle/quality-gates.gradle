/**
 * í’ˆì§ˆ ê²Œì´íŠ¸ í†µí•© ì„¤ì •
 * IntelliJ IDEA Ultimate ë‚´ì¥ ê²€ì‚¬ ë„êµ¬ ìš°ì„  ì‚¬ìš©
 * ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë„êµ¬ë“¤ì€ ì£¼ì„ ì²˜ë¦¬ (board-hole ìŠ¤íƒ€ì¼ ì ìš©)
 */

// ===== ì™¸ë¶€ í’ˆì§ˆ ë„êµ¬ ë¹„í™œì„±í™” =====
// IntelliJ IDEA Ultimateì˜ ë‚´ì¥ ê²€ì‚¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ì™¸ë¶€ ë„êµ¬ ë¹„í™œì„±í™”

/*
// ===== Checkstyle ì„¤ì • =====
checkstyle {
    toolVersion = '10.12.5'
    // í”„ë¡œíŒŒì¼ë³„ ì„¤ì • ì„ íƒ
    if (project.hasProperty('useGoogleStyle')) {
        configFile = file("${rootDir}/config/checkstyle/google-checks-custom.xml")
        println "Using Google Style with custom rules"
    } else {
        configFile = file("${rootDir}/config/checkstyle/checkstyle.xml")
        println "Using project default checkstyle rules"
    }
    maxWarnings = 0
    maxErrors = 0
}

// ===== PMD ì„¤ì • =====
pmd {
    toolVersion = '6.55.0'
    consoleOutput = true
    ruleSetFiles = files("${rootDir}/config/pmd/ruleset.xml")
    rulesMinimumPriority = 1  // Priority 1 ì´ìƒë§Œ ê²€ì‚¬
}

// ===== SpotBugs ì„¤ì • =====
spotbugs {
    toolVersion = '4.8.7'
    effort = 'max'
    reportLevel = 'low'
    excludeFilter = file("${rootDir}/config/spotbugs/exclude.xml")
}
*/

// ===== SonarQube ì„¤ì • =====
sonar {
    properties {
        // ê¸°ë³¸ ì„¤ì •
        property 'sonar.projectKey', project.name
        property 'sonar.projectName', 'Board Hole Application'
        property 'sonar.projectVersion', project.version

        // ì†ŒìŠ¤ ì„¤ì •
        property 'sonar.sources', 'src/main/java'
        property 'sonar.tests', 'src/test/java'
        property 'sonar.java.binaries', 'build/classes/java/main'
        property 'sonar.java.test.binaries', 'build/classes/java/test'
        property 'sonar.java.libraries', 'build/libs/*.jar'

        // Lombok ì§€ì›
        property 'sonar.java.lombok.addLombokGeneratedAnnotation', 'true'

        // ì»¤ë²„ë¦¬ì§€
        property 'sonar.coverage.jacoco.xmlReportPaths', 'build/reports/jacoco/test/jacocoTestReport.xml'
        property 'sonar.junit.reportPaths', 'build/test-results/test'

        // ì œì™¸ íŒ¨í„´
        property 'sonar.exclusions', '''
            **/test/**,
            **/*Test.java,
            **/*Tests.java,
            **/*Config.java,
            **/*Configuration.java,
            **/package-info.java,
            **/*Application.java,
            **/dto/**,
            **/result/**
        '''

        // ì¤‘ë³µ ì½”ë“œ ì œì™¸
        property 'sonar.cpd.exclusions', '''
            **/*Test.java,
            **/*Entity.java,
            **/*DTO.java
        '''

        // ì»¤ìŠ¤í…€ í’ˆì§ˆ í”„ë¡œíŒŒì¼ (ì˜µì…˜)
        // property 'sonar.qualityProfile', 'Board Hole Quality Profile'

        // Import Checkstyle ê²°ê³¼
        property 'sonar.java.checkstyle.reportPaths', 'build/reports/checkstyle/main.xml'

        // Import PMD ê²°ê³¼
        property 'sonar.java.pmd.reportPaths', 'build/reports/pmd/main.xml'

        // Import SpotBugs ê²°ê³¼
        property 'sonar.java.spotbugs.reportPaths', 'build/reports/spotbugs/main.xml'
    }
}

// ===== í’ˆì§ˆ ì²´í¬ í†µí•© íƒœìŠ¤í¬ (IntelliJ ê¸°ë°˜) =====
task qualityGate {
    group = 'verification'
    description = 'Run quality checks (Tests, Coverage) - Use IntelliJ inspections for code analysis'

    dependsOn 'test'
    dependsOn 'jacocoTestReport'

    doLast {
        println """
        ========================================
        í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ! (IntelliJ ê¸°ë°˜)
        ========================================
        âœ… í…ŒìŠ¤íŠ¸: PASSED
        âœ… ì»¤ë²„ë¦¬ì§€: build/reports/jacoco/test/html/
        
        ğŸ“‹ IntelliJ IDEAì—ì„œ ì¶”ê°€ ê²€ì‚¬:
        - Code Inspection (Analyze â†’ Inspect Code)
        - All Inspections Profile í™œì„±í™”ë¨
        - Save Actions í”ŒëŸ¬ê·¸ì¸ í™œì„±í™”ë¨
        
        SonarCloud ë¶„ì„ ì‹¤í–‰:
        ./gradlew sonar -Dsonar.token=YOUR_TOKEN
        ========================================
        """
    }
}

// Google ìŠ¤íƒ€ì¼ë¡œ ì „í™˜
task switchToGoogleStyle {
    group = 'verification'
    description = 'Switch to Google Java Style'
    doLast {
        println "Switched to Google Java Style. Run with: ./gradlew build -PuseGoogleStyle"
    }
}

// ì—„ê²©í•œ í’ˆì§ˆ ê²€ì‚¬ (CI/CDìš©)
task strictQualityCheck {
    group = 'verification'
    description = 'Strict quality check for CI/CD'

    dependsOn qualityGate

    doLast {
        // ì»¤ë²„ë¦¬ì§€ ì²´í¬
        def coverageReport = file("build/reports/jacoco/test/jacocoTestReport.xml")
        if (coverageReport.exists()) {
            println "Coverage report generated"
        } else {
            throw new GradleException("Coverage report not found!")
        }
    }
}

// SonarCloudì™€ ë¡œì»¬ ê²€ì‚¬ ëª¨ë‘ ì‹¤í–‰
task fullQualityAnalysis {
    group = 'verification'
    description = 'Run local quality checks and SonarCloud analysis'

    dependsOn qualityGate
    finalizedBy 'sonar'
}