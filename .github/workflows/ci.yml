name: "Docker Build & Push"

on:
  push:
    branches:
      - main  # ë©”ì¸ ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰
    tags:
      - 'v*'  # ë²„ì „ íƒœê·¸ê°€ í‘¸ì‹œë  ë•Œ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write  # GitHub Packagesì— í‘¸ì‹œí•  ê²½ìš° í•„ìš”

    strategy:
      matrix:
        architecture: [linux/amd64, linux/arm64]  # ë‹¤ì¤‘ ì•„í‚¤í…ì²˜ ë¹Œë“œ

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up QEMU (ë©€í‹° ì•„í‚¤í…ì²˜ ì§€ì›)
        uses: docker/setup-qemu-action@v3

      - name: ğŸ³ Set up Docker Buildx (ë©€í‹° í”Œë«í¼ ë¹Œë“œ í™œì„±í™”)
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”¨ Set up Java 21 (Amazon Corretto)
        uses: actions/setup-java@v4
        with:
          distribution: "corretto"
          java-version: "21"
          architecture: "${{ matrix.architecture }}"
          cache: "gradle"

      - name: ğŸ—ï¸ Build JAR with Gradle
        run: |
          chmod +x gradlew
          ./gradlew build --no-daemon

      - name: ğŸ” Extract JAR File Name
        id: extract_jar
        run: echo "JAR_FILE=$(ls build/libs/*.jar | grep -v 'plain' | head -n 1)" >> $GITHUB_ENV

      - name: ğŸ·ï¸ Set Docker Image Tag
        id: set-tag
        run: |
          VERSION=$(git describe --tags --always --dirty="-dev")
          echo "IMAGE_TAG=${VERSION}" >> $GITHUB_ENV

      - name: ğŸ”‘ Log in to GitHub Container Registry (GHCR)
        if: startsWith(github.ref, 'refs/tags/')
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ³ Build & Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: ${{ startsWith(github.ref, 'refs/tags/') }}  # íƒœê·¸ëœ ê²½ìš°ì—ë§Œ í‘¸ì‹œ
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ github.repository }}:${{ env.IMAGE_TAG }}
            ghcr.io/${{ github.repository }}:latest
          build-args:
            JAR_FILE=${{ env.JAR_FILE }}

      - name: âœ… Build Completed
        run: echo "Docker build & push finished!"